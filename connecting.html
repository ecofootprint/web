<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="ble.js">
    </script>
    <link rel="stylesheet" href="ct.css">
    <title>PikaShoes</title>
    <!-- map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
    #map { height: 400px; }
    #controls { margin-top: 10px; text-align: center; }
  </style>
    <!-- end map-->
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T9LRD3M2');</script>
<!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T9LRD3M2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div id="header">
      <button onClick='connect()' id="ct">
      <img src="https://hufung17.github.io/image/connet.svg" style="float:left;width:100px;height:45px;text-align: center;" alt="bluetooth">
      </button>
      <button id="gd" onclick="location.href='showdata.html'"></button>
      <button id="hm"><a href="index.html">Home</a></button>
    </div>
    <div id="map"></div>
  <div id="controls">
    <button id="startBtn">Start Walk</button>
    <button id="stopBtn" disabled>Stop Walk</button>
    <input type="text" id="routeName" placeholder="Route Name" style="display:none;">
    <button id="saveBtn" style="display:none;">Save Route</button>
    <select id="savedRoutes">
      <option value="">-- Select a saved route --</option>
    </select>
    <button id="loadBtn">Load Route</button>
    <p id="status">Click "Start Walk" to begin tracking your route.</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    let map;
    let routePoints = [];
    let polyline;
    let startMarker;
    let currentMarker;
    let watchId;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const routeNameInput = document.getElementById('routeName');
    const saveBtn = document.getElementById('saveBtn');
    const savedRoutesSelect = document.getElementById('savedRoutes');
    const loadBtn = document.getElementById('loadBtn');
    const status = document.getElementById('status');

    // Check if geolocation is supported
    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser.';
      startBtn.disabled = true;
    } else {
      startBtn.addEventListener('click', startWalk);
      stopBtn.addEventListener('click', stopWalk);
      saveBtn.addEventListener('click', saveRoute);
      loadBtn.addEventListener('click', loadRoute);
    }

    // List saved routes on page load
    document.addEventListener('DOMContentLoaded', listSavedRoutes);

    function startWalk() {
      if (map) {
        map.remove();
        map = null;
      }
      routePoints = [];
      routeNameInput.style.display = 'none';
      saveBtn.style.display = 'none';
      savedRoutesSelect.value = '';
      status.textContent = 'Locating…';
      startBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const initialPoint = L.latLng(lat, lon);
          routePoints = [initialPoint];

          map = L.map('map').setView(initialPoint, 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);

          startMarker = L.marker(initialPoint).addTo(map).bindPopup('Start');
          polyline = L.polyline(routePoints, { color: 'blue' }).addTo(map);
          currentMarker = L.marker(initialPoint).addTo(map);

          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              const newPoint = L.latLng(pos.coords.latitude, pos.coords.longitude);
              routePoints.push(newPoint);
              polyline.setLatLngs(routePoints);
              currentMarker.setLatLng(newPoint);
              map.setView(newPoint);
            },
            (err) => {
              console.error(err);
              status.textContent = 'Unable to retrieve your location.';
            },
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
          );

          stopBtn.disabled = false;
          status.textContent = 'Tracking your walk...';
        },
        (err) => {
          console.error(err);
          status.textContent = 'Unable to retrieve your location. Please allow location access.';
          startBtn.disabled = false;
        },
        { enableHighAccuracy: true }
      );
    }

    function stopWalk() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (routePoints.length > 0) {
        const endPoint = routePoints[routePoints.length - 1];
        L.marker(endPoint).addTo(map).bindPopup('End');
        map.fitBounds(polyline.getBounds());
      }
      stopBtn.disabled = true;
      startBtn.disabled = false;
      routeNameInput.style.display = 'inline';
      saveBtn.style.display = 'inline';
      status.textContent = 'Enter a name and click "Save Route" to save your walk.';
    }

    function saveRoute() {
      const routeName = routeNameInput.value.trim();
      if (!routeName) {
        alert('Please enter a name for the route.');
        return;
      }
      const routeData = JSON.stringify(routePoints.map(point => ({ lat: point.lat, lng: point.lng })));
      localStorage.setItem(`route_${routeName}`, routeData);
      routeNameInput.value = '';
      routeNameInput.style.display = 'none';
      saveBtn.style.display = 'none';
      status.textContent = 'Route saved successfully.';
      listSavedRoutes();
    }

    function listSavedRoutes() {
      savedRoutesSelect.innerHTML = '<option value="">-- Select a saved route --</option>';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('route_')) {
          const routeName = key.substring(6);
          const option = document.createElement('option');
          option.value = routeName;
          option.textContent = routeName;
          savedRoutesSelect.appendChild(option);
        }
      }
    }

    function loadRoute() {
      const selectedRoute = savedRoutesSelect.value;
      if (!selectedRoute) {
        alert('Please select a route to load.');
        return;
      }
      const routeData = localStorage.getItem(`route_${selectedRoute}`);
      if (routeData) {
        const loadedPoints = JSON.parse(routeData).map(point => L.latLng(point.lat, point.lng));
        if (map) {
          map.remove();
        }
        map = L.map('map').setView(loadedPoints[0], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        L.polyline(loadedPoints, { color: 'blue' }).addTo(map);
        L.marker(loadedPoints[0]).addTo(map).bindPopup('Start');
        L.marker(loadedPoints[loadedPoints.length - 1]).addTo(map).bindPopup('End');
        map.fitBounds(L.polyline(loadedPoints).getBounds());
        status.textContent = `Loaded route: ${selectedRoute}`;
      } else {
        status.textContent = 'Failed to load route.';
      }
    }
  </script>
    <footer><p style="text-align:center;">Copyright © 2024 by Hufung</p></footer>
  </body>
</html>
