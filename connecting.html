<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="ble.js">
    </script>
    <link rel="stylesheet" href="ct.css">
    <title>PikaShoes</title>
    <!-- map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
    #map { height: 400px; }
    #controls { margin-top: 10px; text-align: center; }
  </style>
    <!-- end map-->
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T9LRD3M2');</script>
<!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T9LRD3M2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div id="header">
      <button onClick='connect()' id="ct">
      <img src="https://hufung17.github.io/image/connet.svg" style="float:left;width:100px;height:45px;text-align: center;" alt="bluetooth">
      </button>
      <button id="gd" onclick="location.href='showdata.html'"></button>
      <button id="hm"><a href="index.html">Home</a></button>
    </div>
    <div id="map"></div>
  <div id="controls">
    <button id="startBtn">Start Walk</button>
    <button id="stopBtn" disabled>Stop Walk</button>
    <p id="status">Click "Start Walk" to begin tracking your route.</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    let map;
    let routePoints = [];
    let polyline;
    let startMarker;
    let currentMarker;
    let watchId;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');

    // Check if geolocation is supported
    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser.';
      startBtn.disabled = true;
    } else {
      startBtn.addEventListener('click', startWalk);
      stopBtn.addEventListener('click', stopWalk);
    }

    function startWalk() {
      // Clear previous map if it exists
      if (map) {
        map.remove();
        map = null;
      }
      status.textContent = 'Locating…';
      startBtn.disabled = true;

      // Get initial position
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const initialPoint = L.latLng(lat, lon);
          routePoints = [initialPoint];

          // Initialize the map
          map = L.map('map').setView(initialPoint, 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);

          // Add start marker and polyline
          startMarker = L.marker(initialPoint).addTo(map).bindPopup('Start');
          polyline = L.polyline(routePoints, { color: 'blue' }).addTo(map);
          currentMarker = L.marker(initialPoint).addTo(map);

          // Start tracking position
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              const newPoint = L.latLng(pos.coords.latitude, pos.coords.longitude);
              routePoints.push(newPoint);
              polyline.setLatLngs(routePoints);
              currentMarker.setLatLng(newPoint);
              map.setView(newPoint);
            },
            (err) => {
              console.error(err);
              status.textContent = 'Unable to retrieve your location.';
            },
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
          );

          stopBtn.disabled = false;
          status.textContent = 'Tracking your walk...';
        },
        (err) => {
          console.error(err);
          status.textContent = 'Unable to retrieve your location. Please allow location access.';
          startBtn.disabled = false;
        },
        { enableHighAccuracy: true }
      );
    }

    function stopWalk() {
      // Stop tracking
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (routePoints.length > 0) {
        const endPoint = routePoints[routePoints.length - 1];
        L.marker(endPoint).addTo(map).bindPopup('End');
        map.fitBounds(polyline.getBounds());
      }
      stopBtn.disabled = true;
      startBtn.disabled = false;
      status.textContent = 'Your walk route is displayed above.';
    }
  </script>
    <button onClick='disconnect()'>disconnect</button>
    <button onclick="storge()">Store</button>
    <input type="text" id="rn" name="rn" placeholder="Enter The Title">
    <footer><p style="text-align:center;">Copyright © 2024 by Hufung</p></footer>
  </body>
</html>
